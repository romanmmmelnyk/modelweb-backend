name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main || git pull origin master
            
            echo "ðŸ“¦ Installing dependencies..."
            npm ci
            
            echo "ðŸ”§ Setting up Prisma..."
            npm run db:generate
            
            echo "ðŸ—„ï¸  Running migrations..."
            npm run db:migrate || npx prisma db push --accept-data-loss || true
            
            echo "ðŸ”¨ Building application..."
            npm run clean:build
            
            echo "ðŸ“ Creating directories..."
            mkdir -p uploads/gallery uploads/templates logs
            
            echo "ðŸ”„ Restarting server..."
            pm2 stop modelweb-backend 2>/dev/null || true
            pm2 delete modelweb-backend 2>/dev/null || true
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            echo "âœ… Deployment complete!"
            pm2 status modelweb-backend

